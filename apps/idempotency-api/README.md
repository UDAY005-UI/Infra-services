# Idempotency API

A backend-only **idempotency and request deduplication service** that guarantees _at-most-once execution_ for critical operations in distributed systems.

This service is designed to be consumed either directly via HTTP or through a future SDK.

---

## What This Service Does

- Guarantees that a logical operation executes **at most once**
- Makes retries safe after timeouts, crashes, or network failures
- Deduplicates concurrent and sequential duplicate requests
- Returns deterministic responses for repeated requests

---

## What This Service Does NOT Do

- It does not guarantee business success
- It does not handle authentication or authorization
- It does not validate domain-specific payloads
- It does not implement workflows or multi-step processes

This service focuses strictly on **execution correctness**, not business logic.

---

## Core Concepts

### Idempotency Key

A client-generated, opaque identifier representing **one logical attempt**.

- Generated by the client
- Sent on every retry of the same attempt
- Used to deduplicate and coordinate execution

### Operation

A logical identifier describing **what kind of action** the client is attempting.

Examples:

- `"user.create"`
- `"payment.charge"`
- `"email.send"`

Used to prevent semantic collisions when idempotency keys are reused incorrectly.

### Payload

An opaque snapshot of the input data for the operation.

- Treated as data, not logic
- Used for consistency checks
- Prevents unsafe replays with different inputs

---

## API Overview

### Endpoint

```
POST /v1/idempotency/execute
```

### Required Headers

```
Idempotency-Key: <string>
Content-Type: application/json
```

### Request Body

```json
{
    "operation": "string",
    "payload": {}
}
```

---

## Response Semantics

### Completed Execution

```json
{
    "status": "completed",
    "result": {}
}
```

Returned for:

- First successful execution
- Safe replay of a completed request

### Processing

```json
{
    "status": "processing"
}
```

Returned when another request with the same idempotency key is currently executing.

---

## Error Handling

All errors follow a deterministic structure:

```json
{
    "error": {
        "code": "ERROR_CODE",
        "message": "Human readable message"
    }
}
```

- Expected errors are classified and exposed
- Unexpected errors are hidden behind a generic response

---

## Guarantees

- At-most-once execution per idempotency key
- Safe retries without duplicate execution
- Deterministic replay of completed results
- Concurrency-safe coordination

---

## Non-Guarantees

- Business-level correctness
- Domain validation
- Authorization or access control
- Workflow or state-machine enforcement

---

## Current Implementation Status

- HTTP contract implemented
- Controllers and service boundaries defined
- Core idempotency logic **not implemented yet**

The service is currently in a **design-first, contract-stable phase**.

---

## Intended Use Cases

- Prevent duplicate form submissions
- Protect non-idempotent operations behind retry-safe execution
- Act as a correctness guardrail for distributed systems

---

## Future Work

- Idempotency record persistence
- Repository abstraction
- Concurrency control
- Result storage and replay
- SDK implementation
